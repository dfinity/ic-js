#!/usr/bin/env bash
set -eux

npm ci

: Optional tag argument
TAG=

while [[ $# -gt 0 ]]; do
  case "$1" in
  --tag=*)
    TAG="${1#*=}"
    shift
    ;;
  *)
    echo "Unknown argument: $1"
    echo "Usage: ./scripts/build-next [--tag=TAG_NAME]"
    exit 1
    ;;
  esac
done

: Update the package.json version before build and publish
node ./scripts/update-version.mjs utils dfinity $TAG
node ./scripts/update-version.mjs zod-schemas dfinity $TAG
node ./scripts/update-version.mjs nns-proto dfinity $TAG
node ./scripts/update-version.mjs ledger-icp dfinity $TAG
node ./scripts/update-version.mjs ledger-icrc dfinity $TAG
node ./scripts/update-version.mjs nns dfinity $TAG
node ./scripts/update-version.mjs sns dfinity $TAG
node ./scripts/update-version.mjs cmc dfinity $TAG
node ./scripts/update-version.mjs ckbtc dfinity $TAG
node ./scripts/update-version.mjs cketh dfinity $TAG
node ./scripts/update-version.mjs ic-management dfinity $TAG
node ./scripts/update-version.mjs canisters icp-sdk $TAG

: Now we can build
npm run build --workspaces
